"""
帮助系统模块 - 为UI元素添加帮助按钮和提示
"""

from PyQt5.QtWidgets import QPushButton, QLabel, QHBoxLayout, QVBoxLayout, QDialog, QTextBrowser
from PyQt5.QtGui import QIcon, QPixmap, QFont
from PyQt5.QtCore import QSize, Qt

class HelpSystem:
    """帮助系统类，提供为UI元素添加帮助按钮和显示帮助信息的功能"""
    
    # 帮助内容字典，存储所有功能的帮助说明
    help_contents = {
        # 视频模式帮助
        "video_mode": """
        <h3>视频模式说明</h3>
        <p><b>标准模式（重编码）</b>：对视频进行完整处理，支持所有特效，但处理速度较慢</p>
        <ul>
            <li>使用MoviePy库进行视频编辑和特效处理</li>
            <li>所有视频特效和转场都可用</li>
            <li>处理完成后使用FFmpeg进行最终编码</li>
            <li>适合需要高质量特效的场景</li>
        </ul>
        <p><b>快速模式（不重编码）</b>：直接使用FFmpeg处理，速度更快但特效支持有限</p>
        <ul>
            <li>尽可能直接使用FFmpeg处理，减少中间步骤</li>
            <li>最大化利用硬件加速能力</li>
            <li>处理速度通常比标准模式快2-5倍</li>
            <li>部分复杂特效可能不支持或效果有限</li>
        </ul>
        """,
        
        # 比特率设置帮助
        "bitrate": """
        <h3>比特率设置</h3>
        <p>比特率直接影响视频质量和文件大小，单位为kbps（千比特每秒）</p>
        <p><b>手动设置</b>：设置范围为1000k-20000k</p>
        <p><b>推荐值</b>：</p>
        <ul>
            <li>抖音竖屏：4000-8000k</li>
            <li>抖音横屏：3000-6000k</li>
            <li>720p视频：2000-4000k</li>
            <li>1080p视频：4000-8000k</li>
            <li>2K/1440p视频：8000-12000k</li>
            <li>4K/2160p视频：12000-15000k</li>
        </ul>
        <p><b>与原画一致</b>：勾选后自动使用原视频的比特率，保持原有质量</p>
        <p>此功能会：</p>
        <ul>
            <li>自动提取原视频的比特率</li>
            <li>在处理过程中使用相同的比特率值</li>
            <li>保持与原视频相同的质量级别，无需手动设置</li>
        </ul>
        <p>注意：高比特率提供更好的视频质量，但会增加文件大小</p>
        """,
        
        # 编码模式帮助
        "encode_mode": """
        <h3>编码模式详解</h3>
        <p><b>快速模式(不重编码)</b>：</p>
        <ul>
            <li>实现原理：直接使用FFmpeg硬件加速编码，跳过MoviePy的编码流程</li>
            <li>优势：
                <ul>
                    <li>处理速度更快（通常快2-5倍）</li>
                    <li>减少视频质量损失</li>
                    <li>更高效利用GPU资源</li>
                    <li>内存占用更低</li>
                </ul>
            </li>
            <li>劣势：
                <ul>
                    <li>可能与某些特效或转场不兼容</li>
                    <li>在旧GPU或驱动上可能不稳定</li>
                </ul>
            </li>
        </ul>
        <p><b>标准模式(重编码)</b>：</p>
        <ul>
            <li>实现原理：先通过MoviePy处理视频，再使用FFmpeg编码</li>
            <li>优势：
                <ul>
                    <li>更高的兼容性和稳定性</li>
                    <li>支持更丰富的视频处理效果</li>
                    <li>更适合复杂的视频特效和转场</li>
                </ul>
            </li>
            <li>劣势：
                <ul>
                    <li>处理速度较慢，需要两次编码</li>
                    <li>可能导致额外的质量损失</li>
                    <li>内存占用较高</li>
                </ul>
            </li>
        </ul>
        <p>建议：若需要使用复杂转场效果，请选择标准模式；若追求更快的处理速度，请选择快速模式</p>
        """,
        
        # 显卡加速帮助
        "gpu_accel": """
        <h3>硬件加速与GPU利用</h3>
        <p>硬件加速可以大幅提高视频处理速度，尤其是在高分辨率视频处理时</p>
        <p><b>可用选项</b>：</p>
        <ul>
            <li><b>自动检测</b>：自动检测系统中最适合的GPU并使用</li>
            <li><b>NVIDIA显卡</b>：使用NVIDIA GPU的NVENC编码器</li>
            <li><b>AMD显卡</b>：使用AMD GPU的AMF编码器</li>
            <li><b>Intel显卡</b>：使用Intel集成显卡的QSV编码器</li>
            <li><b>CPU处理</b>：不使用GPU加速，完全依靠CPU处理</li>
        </ul>
        <p><b>性能比较</b>：NVIDIA > AMD > Intel > CPU</p>
        <p>点击"检测显卡"按钮可自动检测并配置最适合的硬件加速选项</p>
        <p>注意：在远程桌面会话中，某些GPU加速可能不可用</p>
        """,
        
        # 转场效果帮助
        "transition": """
        <h3>转场效果系统</h3>
        <p>转场效果用于创建视频片段之间的平滑过渡</p>
        <p><b>可用选项</b>：</p>
        <ul>
            <li><b>不使用转场</b>：直接拼接，无过渡效果，生成速度最快</li>
            <li><b>随机转场</b>：在可用的转场效果中随机选择</li>
            <li><b>镜像翻转</b>：创建镜像反转的过渡效果</li>
            <li><b>色相偏移</b>：通过颜色变化创建过渡</li>
            <li><b>光束扫描</b>：模拟光束扫过画面的效果</li>
            <li><b>像素化过渡</b>：通过像素化创建数字风格过渡</li>
            <li><b>轻微旋转缩放</b>：添加微妙的运动感</li>
            <li><b>倒放闪回</b>：创建倒放效果的过渡</li>
            <li><b>速度波动过渡</b>：通过速度变化创建动感</li>
            <li><b>分屏滑动</b>：分割画面并滑动过渡</li>
        </ul>
        <p>注意：在"快速模式(不重编码)"下，某些复杂转场效果可能不可用或效果有限</p>
        """,
        
        # 素材管理帮助
        "material_management": """
        <h3>素材管理系统</h3>
        <p>视频混剪工具支持两种素材组织方式：</p>
        <p><b>1. 独立场景模式</b>：每个添加的文件夹被视为一个独立场景</p>
        <p><b>2. 父文件夹模式</b>：添加父文件夹后，自动识别其中的子文件夹作为不同场景</p>
        <p>对于每个场景文件夹，推荐的文件结构为：</p>
        <pre>
场景文件夹/
├── 视频/      # 包含该场景的视频素材
└── 配音/      # 包含该场景的配音文件（可选）
        </pre>
        <p><b>视频抽取逻辑</b>：</p>
        <ul>
            <li>每个场景文件夹代表视频中的一个段落</li>
            <li>场景按文件夹名称顺序排列，确保视频段落有序</li>
            <li>对每个场景，从对应文件夹中<b>随机</b>选择一个视频</li>
            <li>优先选择时长大于等于音频时长的视频</li>
            <li>避免重复使用同一视频（除非没有其他选择）</li>
            <li>如果没有足够长的视频，选择最长的并循环播放</li>
        </ul>
        <p><b>视频裁剪逻辑</b>：从视频<b>开头</b>开始裁剪，裁剪后的视频时长与音频时长一致</p>
        """,
        
        # 合成模式帮助
        "compose_mode": """
        <h3>合成模式说明</h3>
        <p><b>配音模式</b>：以配音文件为主导，匹配相应的视频</p>
        <ul>
            <li>工作原理：软件会首先读取场景中的配音文件时长</li>
            <li>然后从场景的视频文件夹中选择时长合适的视频素材</li>
            <li>将视频剪辑至与配音时长一致</li>
            <li>视频会从头部开始剪辑，而不是随机位置</li>
            <li>最后将配音与视频合并，生成最终的视频片段</li>
        </ul>
        <p>注意：若场景没有配音文件，将使用无声视频；若场景没有视频文件，则跳过该场景</p>
        """,
        
        # 分辨率设置帮助
        "resolution": """
        <h3>分辨率设置</h3>
        <p>分辨率决定了输出视频的尺寸和清晰度</p>
        <p><b>可用选项</b>：</p>
        <ul>
            <li><b>竖屏 1080x1920</b>：适合抖音、快手等竖屏平台的高清视频</li>
            <li><b>横屏 1920x1080</b>：标准全高清(1080p)分辨率，适合YouTube等横屏平台</li>
            <li><b>竖屏 720x1280</b>：适合移动设备的中等质量竖屏视频，文件更小</li>
            <li><b>横屏 1280x720</b>：标准高清(720p)分辨率，适合对文件大小有限制的场合</li>
        </ul>
        <p>注意事项：</p>
        <ul>
            <li>更高的分辨率提供更清晰的画面，但需要更高的比特率和更多处理时间</li>
            <li>竖屏格式最适合移动设备观看，而横屏格式适合在电脑或电视上观看</li>
            <li>原始视频会自动调整以适应选择的分辨率，保持画面比例不变</li>
        </ul>
        """,
        
        # 音量设置帮助
        "volume_settings": """
        <h3>音量设置</h3>
        <p>调整配音和背景音乐音量以达到最佳效果。</p>
        <ul>
            <li><b>配音音量</b>：调整视频中配音的音量倍数，1.0为原始音量</li>
            <li><b>背景音量</b>：调整背景音乐的音量倍数，通常建议设置低于配音</li>
        </ul>
        <p>一般建议：</p>
        <ul>
            <li>配音音量保持在0.8-1.2之间</li>
            <li>背景音乐音量保持在0.3-0.6之间</li>
        </ul>
        <p>注意：设置过高可能导致音频失真。</p>
        """,
        
        # 背景音乐帮助
        "background_music": """
        <h3>背景音乐设置</h3>
        <p>为视频添加背景音乐，增强视听体验</p>
        <p><b>功能说明</b>：</p>
        <ul>
            <li>支持MP3、WAV、FLAC、OGG、M4A等常见音频格式</li>
            <li>背景音乐会自动循环播放以匹配整个视频长度</li>
            <li>音乐会与配音混合，可通过背景音量调整相对音量</li>
        </ul>
        <p><b>使用建议</b>：</p>
        <ul>
            <li>选择节奏与视频内容相匹配的音乐</li>
            <li>确保使用的音乐没有版权问题</li>
            <li>通过"播放"按钮预览音乐，确保适合您的视频风格</li>
            <li>建议背景音乐音量设置为0.3-0.7，以免掩盖人声配音</li>
        </ul>
        """,
        
        # 生成数量帮助
        "generate_count": """
        <h3>生成数量设置</h3>
        <p>控制一次操作生成的视频数量</p>
        <p><b>功能说明</b>：</p>
        <ul>
            <li>范围：1-500个视频</li>
            <li>每个生成的视频都使用不同的随机组合</li>
            <li>软件会尽量避免相同视频片段的重复使用</li>
        </ul>
        <p><b>使用建议</b>：</p>
        <ul>
            <li>素材数量较少时，建议生成数量也相应减少，避免重复</li>
            <li>每增加一个场景，可以指数级增加可能的组合数量</li>
            <li>生成大量视频将占用更多磁盘空间，请确保有足够的存储容量</li>
            <li>对于测试目的，建议先设置较小的数量(1-5个)检查效果</li>
        </ul>
        """,
        
        # 批量导入帮助
        "batch_import": """
        <h3>批量导入素材文件夹</h3>
        <p>一次性导入多个素材文件夹，提高工作效率</p>

        <h4>操作步骤</h4>
        <ol>
        <li>选择一个根目录，软件会自动扫描其中的所有子文件夹</li>
        <li>符合标准结构的子文件夹（包含"视频"或"配音"子目录）会被添加到素材列表</li>
        <li>不符合要求的文件夹会被自动跳过</li>
        </ol>

        <h4>快捷方式支持</h4>
        <p>软件支持三种导入模式：</p>
        <ol>
        <li><b>标准模式</b>：导入普通文件夹作为素材</li>
        <li><b>快捷方式模式</b>：导入Windows快捷方式(.lnk)指向的文件夹作为素材</li>
        <li><b>混合模式</b>：在同一个父文件夹下，同时支持普通文件夹和快捷方式混合使用</li>
        </ol>

        <p><b>如何使用快捷方式节省空间：</b></p>
        <ol>
        <li>在素材根目录下创建指向实际素材文件夹的快捷方式</li>
        <li>软件会自动解析快捷方式并访问实际的素材目录</li>
        <li>这样可以避免重复复制相同的素材，节省磁盘空间</li>
        <li>混合模式下，部分常用素材可以使用本体，不常用素材可以使用快捷方式</li>
        </ol>

        <p><b>快速创建快捷方式的方法：</b></p>
        <ol>
        <li>在文件资源管理器中找到原始素材文件夹</li>
        <li>右键选择"创建快捷方式"或使用Alt+鼠标拖拽方式创建快捷方式</li>
        <li>将创建的快捷方式移动或复制到您的素材集合文件夹</li>
        <li>在批量导入时选择包含这些快捷方式的父文件夹</li>
        </ol>

        <h4>适用场景</h4>
        <ol>
        <li>当您有大量按场景组织的素材文件夹时</li>
        <li>当素材按照特定命名规则组织，需要保持顺序时</li>
        <li>当需要重复使用相同素材但又不想占用额外磁盘空间时</li>
        </ol>

        <p><b>提示</b>：导入后，素材会按照文件夹名称排序，影响最终视频中场景的顺序。快捷方式在界面中会以特殊图标显示。</p>
        """,
        
        # 缓存目录帮助
        "cache_directory": """
        <h3>缓存目录设置</h3>
        <p>控制临时文件的存储位置和管理</p>
        <p><b>功能说明</b>：</p>
        <ul>
            <li>缓存目录用于存储处理过程中的临时文件</li>
            <li>这些文件包括临时编码的视频、音频片段和中间处理结果</li>
            <li>默认位置为用户个人目录下的VideoMixTool/cache文件夹</li>
        </ul>
        <p><b>缓存管理</b>：</p>
        <ul>
            <li>"清理缓存"按钮可以删除所有临时文件，释放磁盘空间</li>
            <li>如果您的系统磁盘空间不足，可以将缓存目录设置到其他分区</li>
            <li>建议定期清理缓存，特别是在处理大量高分辨率视频后</li>
        </ul>
        <p><b>建议</b>：选择读写速度较快的SSD分区作为缓存目录，可以提高处理速度</p>
        """,
        
        # 分辨率设置帮助
        "dpi_settings": """
        <h3>分辨率设置（DPI）</h3>
        <p>控制输出视频的清晰度和尺寸</p>
        <p><b>可用选项</b>：</p>
        <ul>
            <li><b>竖屏 1080x1920</b>：适合抖音、快手等竖屏平台的高清视频</li>
            <li><b>横屏 1920x1080</b>：标准全高清(1080p)分辨率，适合YouTube等横屏平台</li>
            <li><b>竖屏 720x1280</b>：适合移动设备的中等质量竖屏视频，文件更小</li>
            <li><b>横屏 1280x720</b>：标准高清(720p)分辨率，适合对文件大小有限制的场合</li>
        </ul>
        <p>选择适当的分辨率取决于您的目标平台和视频内容：</p>
        <ul>
            <li>移动平台和社交媒体：竖屏格式（9:16）更符合手机用户习惯</li>
            <li>YouTube等视频平台：横屏格式（16:9）是标准选择</li>
            <li>较高的分辨率提供更好的画质，但需要更高的比特率和存储空间</li>
        </ul>
        """,
        
        # 保存目录帮助
        "save_directory": """
        <h3>保存目录设置</h3>
        <p>控制生成视频的存储位置</p>
        <p><b>功能说明</b>：</p>
        <ul>
            <li>所有生成的视频文件将保存在此目录中</li>
            <li>软件会自动创建目录（如果不存在）</li>
            <li>"打开"按钮可以直接在文件资源管理器中查看该目录</li>
        </ul>
        <p><b>提示</b>：</p>
        <ul>
            <li>建议选择空间充足的分区作为保存目录</li>
            <li>高分辨率视频和大量生成可能占用大量存储空间</li>
            <li>生成的视频文件名会自动包含时间戳和序号，便于管理</li>
        </ul>
        """,
        
        # 与原画一致选项帮助
        "original_bitrate": """
        <h3>与原画一致选项</h3>
        <p>自动使用源视频的比特率，保持原始画质</p>
        <p><b>工作原理</b>：</p>
        <ul>
            <li>启用此选项后，软件会自动分析源视频的比特率</li>
            <li>在生成新视频时使用相同的比特率设置</li>
            <li>比特率输入框会被禁用，使用提取的值</li>
        </ul>
        <p><b>优势</b>：</p>
        <ul>
            <li>保持与原视频相同的质量级别</li>
            <li>无需手动测量和设置比特率</li>
            <li>避免不必要的质量损失或文件膨胀</li>
        </ul>
        <p><b>注意</b>：如果源视频的比特率非常高，可能会导致输出文件较大</p>
        """,
        
        # 主要功能帮助
        "main_features": """
        <h3>主要功能说明</h3>
        <p>短视频批量混剪工具可以帮助您高效地创建多个不同的视频作品</p>
        <p><b>核心功能</b>：</p>
        <ul>
            <li><b>批量生成</b>：一次操作生成多个视频，每个视频使用不同的素材组合</li>
            <li><b>场景管理</b>：按照场景组织视频和音频素材，保持叙事结构</li>
            <li><b>自动配音</b>：根据配音文件自动剪辑匹配的视频片段</li>
            <li><b>丰富转场</b>：多种转场效果选择，使视频衔接自然流畅</li>
            <li><b>硬件加速</b>：支持NVIDIA、AMD和Intel显卡加速，提高处理速度</li>
            <li><b>背景音乐</b>：添加背景音乐并调节与配音的音量平衡</li>
        </ul>
        <p><b>工作流程</b>：</p>
        <ol>
            <li>添加或批量导入素材文件夹</li>
            <li>设置输出参数（分辨率、比特率、转场等）</li>
            <li>选择保存目录和生成数量</li>
            <li>点击"开始合成"按钮</li>
            <li>等待处理完成，在保存目录中查看生成的视频</li>
        </ol>
        <p><b>提示</b>：首次使用时，建议先生成少量视频测试效果，再批量生成大量视频</p>
        """,
        
        # 性能优化提示
        "performance_tips": """
        <h3>性能优化提示</h3>
        <p>以下是一些提高软件处理速度和效率的建议：</p>
        
        <h4>硬件加速设置</h4>
        <ul>
            <li>使用"检测显卡"功能自动配置最佳硬件加速选项</li>
            <li>NVIDIA显卡提供最佳的加速效果，其次是AMD和Intel显卡</li>
            <li>确保显卡驱动是最新版本，以获得最佳兼容性</li>
            <li>远程桌面会话中硬件加速可能受限，尽量在本地操作</li>
        </ul>
        
        <h4>编码模式选择</h4>
        <ul>
            <li>优先选择"快速模式(不重编码)"，速度通常比标准模式快2-5倍</li>
            <li>如果需要复杂转场效果，则需要使用"标准模式(重编码)"</li>
            <li>大批量处理时，建议禁用复杂转场效果，提高处理速度</li>
        </ul>
        
        <h4>素材管理优化</h4>
        <ul>
            <li>优先使用MP4或MOV格式的视频素材，处理速度更快</li>
            <li>避免使用过高分辨率的原始素材(如4K)，除非输出也需要4K</li>
            <li>使用SSD存储素材和设置缓存目录可显著提高读写速度</li>
            <li>定期清理缓存目录，释放磁盘空间</li>
        </ul>
        
        <h4>系统调优</h4>
        <ul>
            <li>关闭其他占用GPU资源的应用程序</li>
            <li>确保系统有足够的可用内存(建议8GB以上)</li>
            <li>在批量处理大量视频前，重启软件可以避免内存泄漏问题</li>
            <li>Windows系统可以调整电源计划为"高性能"模式</li>
        </ul>
        
        <h4>分批处理</h4>
        <ul>
            <li>处理大量视频时，建议分成多个小批次(每批20-50个)</li>
            <li>每批处理完成后，可以清理缓存释放资源</li>
            <li>避免一次性生成过多视频，以防系统资源耗尽</li>
        </ul>
        """,
        
        # 添加水印帮助信息
        "watermark": """
        <h3>时间戳水印</h3>
        <p>时间戳水印功能可以帮助您跟踪视频的创建时间，便于视频溯源。</p>
        <p><b>主要功能:</b></p>
        <ul>
            <li><b>时间戳格式</b>：水印显示格式为 "自定义前缀+年.月日.时分"，例如 "外星人2025.419.902"</li>
            <li><b>自动编号</b>：对于同一分钟内生成的多个视频，会自动在时间戳后添加编号，如 "2025.419.902(1)"</li>
            <li><b>可自定义</b>：您可以设置水印的字体大小、颜色、位置等属性</li>
        </ul>
        <p><b>设置选项:</b></p>
        <ul>
            <li><b>自定义前缀</b>：在时间戳前添加自定义文字，如机器名称或标识</li>
            <li><b>字体大小</b>：调整水印文字的大小(10-100像素)</li>
            <li><b>字体颜色</b>：选择预设颜色或使用自定义颜色</li>
            <li><b>水印位置</b>：选择水印在视频中的位置(默认右上角)</li>
            <li><b>位置微调</b>：使用X/Y值微调水印的具体位置</li>
        </ul>
        <p><b>注意事项:</b></p>
        <ul>
            <li>水印添加在视频最后导出阶段，不会影响视频质量</li>
            <li>字体颜色建议选择与视频内容对比度高的颜色，确保清晰可见</li>
            <li>微调功能可以帮助您避开视频中的重要内容区域</li>
        </ul>
        """,
    }
    
    @staticmethod
    def add_help_button(layout, widget_id):
        """
        为指定布局添加帮助按钮
        
        Args:
            layout: 要添加按钮的布局
            widget_id: 帮助内容的ID，对应help_contents字典中的键
        """
        # 创建帮助按钮
        help_btn = QPushButton("?")
        help_btn.setFixedSize(20, 20)
        help_btn.setToolTip("点击查看帮助")
        help_btn.setStyleSheet("""
            QPushButton {
                background-color: #f0f0f0;
                border-radius: 10px;
                border: 1px solid #cccccc;
                color: #0078d7;
                font-weight: bold;
            }
            QPushButton:hover {
                background-color: #e0e0e0;
            }
        """)
        
        # 添加到布局
        layout.addWidget(help_btn)
        
        # 连接点击事件
        help_btn.clicked.connect(lambda: HelpSystem.show_help_dialog(widget_id))
        
        return help_btn
    
    @staticmethod
    def show_help_dialog(widget_id):
        """
        显示帮助对话框
        
        Args:
            widget_id: 帮助内容的ID，对应help_contents字典中的键
        """
        # 创建对话框
        dialog = QDialog()
        dialog.setWindowTitle("功能帮助")
        dialog.setMinimumSize(500, 400)
        
        # 创建布局
        layout = QVBoxLayout(dialog)
        
        # 创建文本浏览器显示帮助内容
        text_browser = QTextBrowser()
        text_browser.setOpenExternalLinks(True)
        
        # 设置帮助内容
        if widget_id in HelpSystem.help_contents:
            help_content = HelpSystem.help_contents[widget_id]
            text_browser.setHtml(help_content)
        else:
            text_browser.setHtml("<h3>未找到帮助内容</h3><p>抱歉，此功能的帮助信息尚未添加。</p>")
        
        # 添加到布局
        layout.addWidget(text_browser)
        
        # 显示对话框
        dialog.setLayout(layout)
        dialog.exec_()

    @staticmethod
    def get_help_text(topic):
        """获取指定主题的帮助文本"""
        return HelpSystem.help_contents.get(topic, "") 